<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>ShaderTime</title>
        <style type="text/css">
            body {
                font-family: sans-serif;
                background: #eee;
                color: #333;
                margin: 0;
                padding: 0;
            }

            .panel {
                background: #fff;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            }

            #shadeMe {
                height: 100vh;
                background: #000;
            }

            #controls {
                position: absolute;
                bottom: 0;
                left: 0;
                padding: 0.5em 1em;
            }

            #controls button {
                padding: 0 1em;
                line-height: 3em;
                color: #ffffff;
                background: rgba(255, 255, 255, 0.25);
                border: 1px solid rgba(255, 255, 255, 0.5);
                border-radius: 0.2em;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            }
        </style>
    </head>
    <body>

        <div class="page clearfix">
        	<div class="panel" id="shadeMe">
            <!-- .panel --></div>
            <div id="controls"></div>
        <!-- #page --></div>

        <script src="script/fss.js"></script>
        <script src="script/shadedSurface.js"></script>

        <script>
            /**
             * Taken from: https://github.com/mjackson/mjijackson.github.com/blob/master/2008/02/rgb-to-hsl-and-rgb-to-hsv-color-model-conversion-algorithms-in-javascript.txt
             * By Michael Jackson
             *
             */



            /**
             * Converts an RGB color value to HSL. Conversion formula
             * adapted from http://en.wikipedia.org/wiki/HSL_color_space.
             * Assumes r, g, and b are contained in the set [0, 255] and
             * returns h, s, and l in the set [0, 1].
             *
             * @param   Number  r       The red color value
             * @param   Number  g       The green color value
             * @param   Number  b       The blue color value
             * @return  Array           The HSL representation
             */
            function rgbToHsl(r, g, b){
                r /= 255, g /= 255, b /= 255;
                var max = Math.max(r, g, b), min = Math.min(r, g, b);
                var h, s, l = (max + min) / 2;

                if(max == min){
                    h = s = 0; // achromatic
                }else{
                    var d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch(max){
                        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                        case g: h = (b - r) / d + 2; break;
                        case b: h = (r - g) / d + 4; break;
                    }
                    h /= 6;
                }

                return [h, s, l];
            }

            /**
             * Converts an HSL color value to RGB. Conversion formula
             * adapted from http://en.wikipedia.org/wiki/HSL_color_space.
             * Assumes h, s, and l are contained in the set [0, 1] and
             * returns r, g, and b in the set [0, 255].
             *
             * @param   Number  h       The hue
             * @param   Number  s       The saturation
             * @param   Number  l       The lightness
             * @return  Array           The RGB representation
             */
            function hslToRgb(h, s, l){
                var r, g, b;

                if(s == 0){
                    r = g = b = l; // achromatic
                }else{
                    function hue2rgb(p, q, t){
                        if(t < 0) t += 1;
                        if(t > 1) t -= 1;
                        if(t < 1/6) return p + (q - p) * 6 * t;
                        if(t < 1/2) return q;
                        if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                        return p;
                    }

                    var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    var p = 2 * l - q;
                    r = hue2rgb(p, q, h + 1/3);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1/3);
                }

                return [r * 255, g * 255, b * 255];
            }


            // My utils

            function toHex(rgb) {
                function fromN(N) {
                    var h = Number(N).toString(16);
                    // zero pad single digit values for proper hex
                    return (h.length === 1) ? "0" + h : h;
                }
                return '#' + fromN(rgb.r) + fromN(rgb.g) + fromN(rgb.b)
            }

            function toRgb(hex) {
                if (hex[0] === '#') {
                    hex = hex.slice(1);
                }
                if (hex.length === 3) {
                    hex = '' + hex[0] + hex[0]
                        + hex[1] + hex[1]
                        + hex[2] + hex[2];
                }
                function toN(hexFrag) {
                    return parseInt(hexFrag, 16)
                }
                return {
                    r: toN(hex.slice(0,2)),
                    g: toN(hex.slice(2,4)),
                    b: toN(hex.slice(4,6))
                }
            }



            function extend(a, b){
                for (key in b) {
                    if (b.hasOwnProperty(key)) {
                        a[key] = b[key]
                    }
                }
                return a;
            };


            function setSurface(opts) {
                var settings = extend({
                    cellsize: 50,
                    jitter: 0.3,
                    depth: 2.5,
                    materialAmbient: '#ffffff',
                    materialDiffuse: '#ffffff',
                    fillOpacity: 0.8,
                    strokeOpacity: 1,
                    strokeWidth: 1,

                    container: '#shadeMe',
                    renderWith: 'canvas'
                }, opts);
                document.querySelector(settings.container).innerHTML = '';
                demoSurface = new ShadedSurface(settings, settings.lights);

                demoSurface.initialize()
                    .resize()
                    .draw();
            }
            var show = setSurface;


            var el = document.getElementById('shadeMe');
            var elw = el.offsetWidth;
            var elh = el.offsetHeight;

            function generateLights(x, y) {
                if (x === undefined) x = 0;
                if (y === undefined) y = 0;


                //Math.sin(Math.PI * x/w + Math.PI/2);
                // sin-squared normalized factor for progress across day,
                // here modeled for x-pos across element
                var dayFactor = function() {
                    return Math.pow(Math.sin(Math.PI/2 + Math.PI * x/elw), 2);
                }

                // shift ambient bg color
                var bgColor = toRgb('#20292f');
                bgColor = rgbToHsl(bgColor.r, bgColor.g, bgColor.b);
                bgColor[0] -= (x/elw * 0.4);
                bgColor = hslToRgb(bgColor[0], bgColor[1], bgColor[2]).map(Math.round);
                bgColor = toHex({r: bgColor[0], g:bgColor[1], b:bgColor[2]});

                var ambient = {
                        ambient: bgColor,
                        diffuse: '#000000',
                        x: function(w, h) {return 0},
                        y: function(w, h) {return 0},
                        z: function(w, h) {
                            return 300 * w/1300
                        }
                    };
                var lights = [ambient];

                var bright = {
                    ambient: '#000000',
                    diffuse: '#3399cc',
                    x: function(w, h) {return x * 1.25},
                    y: function(w, h) {return -h/4 + h*3/4 * dayFactor()},
                    z: function(w, h) {
                        return (100 + 150 * dayFactor()) * w/1300
                    }
                }

                var counter = {
                    ambient: '#000000',
                    diffuse: '#ff0099',
                    x: function(w, h) {return -x*1.2},
                    y: function(w, h) {return -h * 0.8},
                    z: function(w, h) {
                        return (300 - 100 * dayFactor()) * w/1300
                    }
                }

                lights.push(bright);
                lights.push(counter);

                return {lights: lights};
            }

            var drawAtPoint = function(e) {
                show(generateLights(e.clientX - elw/2, - (e.clientY - elh/2)));
            }


            // drag with mouse
            el.addEventListener('mousedown', function(e){
                el.addEventListener('mousemove', drawAtPoint);
                drawAtPoint(e);
            });
            // unbind drag handler
            el.addEventListener('mouseup', function(e){
                el.removeEventListener('mousemove', drawAtPoint);
            });

            var now = new Date();
            var start = new Date();
            start.setHours(0);
            start.setMinutes(0);
            start.setSeconds(0);

            var t = (now - start)/86400000;

            drawAtPoint({ clientX: (1 - t) * elw });

        </script>

    </body>
</html>